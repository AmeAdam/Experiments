@using System.Threading.Tasks
@using AmeCommon.Tasks
@using AmeWeb.Model
@model AmeCommon.CardsCapture.CaptureProjectCommand

<div class="row">
    <h2>Projekt: @Model.Project.UniqueName</h2>
    <h4>@Model.Project.LocalPathRoot</h4>

        <table class="table table-condensed table-bordered">
            <tr>
                <th></th>
                <th>Device</th>
                <th>Info</th>
                <th>Stan</th>
            </tr>
            @for (var i = 0; i < Model.DeviceCommands.Count; i++)
            {
                var device = Model.DeviceCommands[i];
                var hasConflict = device.GetAllConflictWithStoredFiles().Any();
                var trClass = hasConflict ? "bg-danger" : "";
                var imagePath = $"/images/{device.Device.UniqueName}.jpg";
                <tr class="@trClass">
                    <td><img src="@imagePath" style="height: 75px" /></td>
                    <td>@device.Device.UniqueName</td>
                    <td class="DeviceInfo">
                        Pliki: @device.FilesCount<br />
                        Rozmiar: @device.FilesSize.DisplayFileSize()<br />
                        Ukończono: @device.PercentCompleted %<br />
                        @if (hasConflict)
                        {
                            @Html.ActionLink("Uwaga! Wykryto konflikt istniejących plików.", "ShowConflicts", new { projectPath = Model.Project.LocalPathRoot, device.SourceDrive }, new { style = "font-weight: bold" })
                        }
                    </td>
                    <td class="DeviceState">
                        @if (device.State == TaskState.InProgress)
                        {
                            <img src="~/images/loader.gif" style="height: 75px" />
                            @Html.ActionLink("Przerwij", "AbortCaptureDevice", new { projectPath = Model.Project.LocalPathRoot, deviceId = device.Device.Id })
                        }
                        else if (device.State == TaskState.Completed || device.Commands.Count == 0)
                        {
                            <img src="~/images/done.png" style="height: 75px" />
                        }
                        else if (device.State == TaskState.Error || device.State == TaskState.Aborted)
                        {
                            <img src="~/images/error.png" style="height: 75px" />
                            <span class="text-danger">@device.Error</span>
                        }
                        else
                        {
                            @Html.ActionLink("Kopiuj do projektu", "StartCaptureSingleDevice", new { projectPath = Model.Project.LocalPathRoot, sourceDrive = device.SourceDrive })
                        }
                    </td>
                </tr>
            }
        </table>
</div>
